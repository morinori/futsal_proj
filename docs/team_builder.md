# Team Builder Specification

## 배경
- 관리자들이 경기별 참석자 명단만으로 즉시 팀을 편성할 수 있는 도구가 필요하다.
- 현재 출석 페이지는 참석 현황까지만 제공하며, 팀 분배/벤치 관리 기능이 없다.
- 본 기능은 향후 경기 운영 자동화의 기반이므로 Streamlit UI 패턴과 기존 서비스 계층을 준수해야 한다.

## 목표
- 선택한 경기의 `present` 상태 선수만 활용해 팀을 신속하게 구성한다.
- 팀 수와 팀당 인원을 유연하게 조정하며 실시간 검증/피드백을 제공한다.
- 자동 분배와 수동 수정 모두를 지원하고, 결과를 쉽게 공유할 수 있도록 내보내기 옵션을 제공한다.
- 경기 전환/새로고침에도 최근 설정이 유지되도록 세션 상태를 안정적으로 관리한다.

## 비범위 (Out of Scope)
- 선수 스탯·포지션 기반의 고급 매칭 알고리즘(우선은 균등 분배 중심).
- 출석 상태 변경/신규 선수 등록(기존 출석/선수 관리 페이지에서 처리).
- 팀 편성 결과를 DB에 저장하는 기능(현 단계에서는 세션/프론트 상태에만 유지).
- 모바일 푸시, 알림 등 외부 공유 채널.

## 사용자 및 접근 권한
- `is_admin` 세션이 True인 관리자만 접근 가능하다.
- `ui/components/auth.require_admin_access` 패턴을 재사용해 인증을 강제한다.

## 핵심 시나리오
1. 관리자가 팀 구성 페이지 진입 → 기본적으로 다음 경기 또는 최근에 작업한 경기로 프리셀렉트.
2. 경기 선택 후 참석자 목록과 요약 메트릭(참석/불참/미정)이 로드된다.
3. 관리자가 팀 수와 팀당 인원을 지정하거나, 한쪽만 입력하고 나머지를 자동 계산하도록 설정한다.
4. 시스템이 입력 값을 검증하고 적절한 균등 분배안을 제안한다.
5. 관리자는 자동 분배 결과를 확인하고 드래그/체크박스 등으로 수동 조정한다.
6. 벤치 인원(분배 후 잔여 인원)을 별도 리스트로 확인하고, 필요 시 특정 팀에 추가한다.
7. 최종 구성은 클립보드 복사/CSV 다운로드 등으로 공유할 수 있다.

## UI / UX 설계
- 페이지 헤더: 경기 요약 카드(날짜, 시간, 장소, 참석자 수, 팀 구성 현황).
- **경기 선택 영역**
  - `st.selectbox` + 검색 가능한 옵션, 경기 날짜/상대/구장 표시.
  - "다가오는 경기"와 "지난 경기" 탭을 두고 최근 N경기까지만 로드한다.
  - 새로운 경기 선택 시 기존 편성 데이터를 덮어쓸지 확인 모달 표시.
- **팀 설정 카드**
  - 입력 모드 토글: `팀 개수 기반` vs `팀당 인원 기반`.
  - 양쪽 수치를 모두 입력할 경우 상호 검증하여 불일치 시 경고.
  - 계산 결과: 필요 인원, 남는 인원, 추천 분배안(예: "4팀 × 3명 + 벤치 0명").
  - 옵션: `잔여 인원 자동 벤치`, `팀별 잔여 분산` 토글.
- **팀 편성 영역**
  - 자동 분배 버튼: 균등 + 랜덤 셔플.
  - 팀별 카드: 팀 이름(Team A/B 등 변경 가능), 현재 인원, 최대 인원.
  - 팀 카드 내 플레이어 리스트 + 수동 편집 인터랙션(`st.data_editor`, 태그형 리스트, 혹은 라디오 버튼 등 Streamlit 기본 컴포넌트 기반).
  - 벤치/대기 인원 박스: 드래그&드롭은 Streamlit 기본 기능 한계 때문에 버튼 기반 이동(예: `팀에 추가`/`벤치로 이동`).
- **결과 요약 & 액션 영역**
  - 팀 구성 표(팀명, 선수 명단, 인원수, 교체 인원).
  - 클립보드 복사 버튼(`st.code` + `st.button` 조합)과 CSV 다운로드(`st.download_button`).
  - "다시 분배"/"설정 초기화" 버튼.

## 상태 관리
- `st.session_state['team_builder']` 딕셔너리로 경기별 상태를 보관한다.
  - 키: `match_{match_id}` → 값: `{"config": {...}, "teams": [...], "bench": [...]}`.
  - 현재 선택 경기 키: `team_builder_selected_match_id`.
- 새 경기 선택 시 기존 상태를 확인하고 필요 시 백업 후 초기화.
- 상태 저장 트리거: 팀 설정 변경, 자동 분배 실행, 수동 편집 완료.

## 서비스 & 데이터 의존성
- 출석 데이터: `AttendanceService.get_match_attendance(match_id)` → `status == 'present'`인 선수만 사용.
- 경기 정보: `MatchService.get_all_matches()` 혹은 범위 제한 함수(성능 고려 필요).
- 신규 서비스: `services/team_builder_service.py`
  - `calculate_layout(total_present: int, team_count: int | None, team_size: int | None) -> LayoutResult`
    - 입력 검증, 최소/최대 범위, 잔여 인원 계산.
    - 예외 상황: 팀 수 * 팀 인원 < 참석자 수 → 추가 벤치로 안내.
  - `distribute_players(players: List[Player], team_count: int, team_size: int, strategy: str = "balanced_random") -> Distribution`
    - 기본 전략: 셔플 후 라운드로빈.
    - 추가 전략 훅: 포지션 기준 분배(향후).
  - `rebalance_with_remainder(teams, bench, mode="bench" | "spread")`
- 기존 Repository/DB 변경은 필요 없음.

## 검증 규칙
- 팀 수/팀당 인원은 1 이상 정수.
- 팀 수 * 팀당 인원 < 참석자 수 → 잔여 인원 = 참석자 수 - (팀 수 * 팀당 인원).
- 팀 수 * 팀당 인원 > 참석자 수 → 입력 오류 메시지와 자동 보정 제안(팀당 인원 감소 혹은 벤치 없음 모드 비활성화).
- `present` 인원이 0이면 팀 구성 영역 비활성화 후 안내 메시지.
- 동일 선수가 여러 팀에 중복되면 안 되므로 수동 편집 시 검증.

## 보안 & 가드레일
- 관리자 세션이 아닐 경우 즉시 접근 차단 후 로그인 페이지 안내.
- 서비스 계층에서 외부 입력 검증을 수행하고, UI에서는 Streamlit 위젯 값에 대한 추가 체크만 담당한다.
- 출석 데이터는 읽기 전용으로 사용하며, 팀 편성 결과는 DB에 쓰지 않는다.
- `docs/vuln.md`의 가이드 준수: URL 파라미터 세션 복원 금지, SQL 직접 호출 금지.

## 성능 고려
- 경기 목록은 월 또는 제한된 범위로 조회하여 UI 초기 렌더링을 가볍게 유지.
- 자동 분배 알고리즘은 O(n) 수준으로 참석자 수(최대 수십 명 가정)에서 충분히 빠르다.
- 세션 상태 저장 시 불필요한 큰 오브젝트(예: 전체 선수 데이터) 대신 최소한의 구조만 보관.

## 테스트 전략
- 서비스 레벨 유닛 테스트: `calculate_layout` (경계값, 입력 오류, 잔여 인원 처리), `distribute_players` (균등 분배, 잔여 처리, 전략 파라미터).
- UI 수동 테스트 체크리스트
  - 경기 선택 변경, 세션 상태 유지/초기화 흐름.
  - 팀 수/팀당 인원 조합별 경고 메시지.
  - 자동 분배 후 수동 조정(벤치 이동 포함).
  - CSV/복사 기능 정상 작동.
  - 참석자 부족/과다 시 UX 메시지.

## 오픈 질문
1. 팀명 커스터마이징(예: Team 1 → 홍팀/청팀)을 저장할 필요가 있는가?
2. 포지션/실력치 기반의 분배 전략을 언제 도입할지 로드맵 정의 필요.
3. 팀 편성 결과를 향후 통계 페이지나 경기 기록과 연동할 계획이 있는가?
4. CSV 외에 이미지/표 캡쳐 등 공유 포맷 요구가 있는가?

## 후속 작업 제안
- 테스트 커버리지 확보 후 `docs/TEST_PLAN.md`에 새 시나리오 추가.
- 기능 출시 시 `docs/CHANGELOG.md` 업데이트.
- 향후 단계에서 팀 편성 결과를 경기 리포트에 포함시키는 RFC 검토.
